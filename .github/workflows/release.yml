on:
  push:
    branches: [main]

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get commit history
        id: get_commits
        run: |
          git log --pretty=format:'%s' > commits.txt  # Get all commit messages

      - name: Generate changelog
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const commits = fs.readFileSync('commits.txt', 'utf8').split('\n');
            let changelog = '';
            let versionTag = '';

            // Append each commit to the changelog, formatted properly
            commits.forEach(commit => {
              const match = commit.match(/^(feat|fix)\((.*)\): (.*)/);
              if (match) {
                const type = match[1];
                const branch = match[2];
                const description = match[3];
                changelog += `* **${type}(${branch})**: ${description}\n`;
              }
            });

            // Read current changelog file if it exists, and append new content
            if (fs.existsSync('CHANGELOG.md')) {
              const existingChangelog = fs.readFileSync('CHANGELOG.md', 'utf8');
              changelog = existingChangelog + '\n' + changelog;
            }

            // Write the updated changelog to the file
            fs.writeFileSync('CHANGELOG.md', changelog);

      - name: Commit and push changelog
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG.md"
          git push origin main

      - name: Create GitHub release
        id: create_release
        run: |
          # Get the latest commit message that will serve as the release title
          COMMIT_MESSAGE=$(tail -n 1 commits.txt)
          VERSION_TAG=$(echo "$COMMIT_MESSAGE" | grep -oP '^feat\([^)]+\): \K.+' | sed 's/ /_/g')

          # If no valid commit message found, use a default version tag
          if [ -z "$VERSION_TAG" ]; then
            VERSION_TAG="v0.1.0"
          fi

          # Create a release with the extracted version tag
          gh release create "$VERSION_TAG" --title "$VERSION_TAG" --notes "$COMMIT_MESSAGE" --generate-notes

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
