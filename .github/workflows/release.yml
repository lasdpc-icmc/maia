on:
  push:
    branches: [main]

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get commit history
        id: get_commits
        run: |
          git log --pretty=format:'%s' > commits.txt  # Get all commit messages

      - name: Generate changelog
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const commits = fs.readFileSync('commits.txt', 'utf8').split('\n');
            let changelog = '';

            // Append each commit to the changelog, formatted properly
            commits.forEach(commit => {
              const match = commit.match(/^(feat|fix)\((.*)\): (.*)/);
              if (match) {
                const type = match[1];
                const branch = match[2];
                const description = match[3];
                changelog += `* **${type}(${branch})**: ${description}\n`;
              }
            });

            // Read current changelog file if it exists, and append new content
            if (fs.existsSync('CHANGELOG.md')) {
              const existingChangelog = fs.readFileSync('CHANGELOG.md', 'utf8');
              changelog = existingChangelog + '\n' + changelog;
            }

            // Write the updated changelog to the file
            fs.writeFileSync('CHANGELOG.md', changelog);

      - name: Commit and push changelog
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG.md"
          git push origin main

      - name: Get the latest release tag
        id: get_latest_release
        run: |
          latest_tag=$(git tag -l "v*" | sort -V | tail -n 1)
          if [ -z "$latest_tag" ]; then
            latest_tag="v1.0.0"  # Default if no tags exist
          fi
          echo "Latest tag is $latest_tag"
          echo "::set-output name=latest_tag::$latest_tag" 

  create-release:
    runs-on: ubuntu-latest
    needs: generate-changelog
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create new release tag
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest_tag=${{ steps.get_latest_release.outputs.latest_tag }}
          VERSION_TAG=${latest_tag:-v1.0.0} 
          if [[ $(git tag -l | grep -w "$VERSION_TAG") ]]; then exit 0; fi; 
          NEW_VERSION=$(echo $VERSION_TAG | awk -F. -v OFS=. '{$NF++;print}')
          gh release create "v$NEW_VERSION" --title "v$NEW_VERSION" --notes "$(tail -n 1 commits.txt)" --generate-notes